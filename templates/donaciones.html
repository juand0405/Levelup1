<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Donaciones</title>
    <script src="https://checkout.wompi.co/widget.js"></script>
</head>
<body>
    <h1>Haz una donación</h1>

    <label>Creador:</label>
    <select id="creator_id">
        {% for c in creators %}
        <option value="{{ c.id }}">{{ c.username }}</option>
        {% endfor %}
    </select>

    <label>Juego (opcional):</label>
    <select id="game_id">
        <option value="">-- Ninguno --</option>
        {% for g in games %}
        <option value="{{ g.id }}">{{ g.name }}</option>
        {% endfor %}
    </select>

    <label>Monto (COP):</label>
    <input type="number" id="amount" min="100" step="100" />

    <button id="payButton">Donar con Wompi</button>
<script>
document.getElementById('payButton').addEventListener('click', async function() {
    const creator_id = document.getElementById('creator_id').value;
    const game_id = document.getElementById('game_id').value;
    const amount = document.getElementById('amount').value;

    if (!amount || amount < 100) {
        alert("Monto mínimo: 100 COP");
        return;
    }

    try {
        const resp = await fetch("/donaciones", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ creator_id, game_id, amount })
        });

        // Si el servidor devuelve error 500 o similar
        if (!resp.ok) {
            const text = await resp.text();
            console.error("Error en respuesta del servidor:", text);
            alert("Error al procesar la donación (HTTP " + resp.status + ")");
            return;
        }

        // Intentar parsear JSON
        let data;
        try {
            data = await resp.json();
        } catch (parseError) {
            console.error("Respuesta no es JSON:", parseError);
            alert("Error al leer respuesta del servidor");
            return;
        }

        if (!data.success) {
            alert("Error del servidor: " + (data.error || "Error desconocido"));
            return;
        }

        const wompi = data.wompi;
        console.log("✅ Wompi params recibidos:", wompi);

        const checkout = new WidgetCheckout({
        currency: wompi.currency,
        amountInCents: wompi.amountInCents,
        reference: wompi.reference,
        publicKey: wompi.publicKey,
        redirectUrl: wompi.redirectUrl,
        customerData: wompi.customerData,

        // ✅ Agregar firma obligatoria:
        signature: {
            integrity: wompi.signature
        }
        });

        checkout.open((result) => {
            console.log("Resultado del widget:", result);
            window.location.href = wompi.redirectUrl;
        });

    } catch (err) {
        console.error("❌ Error de conexión:", err);
        alert("Error de conexión con el servidor");
    }
});
</script>

</body>
</html>
